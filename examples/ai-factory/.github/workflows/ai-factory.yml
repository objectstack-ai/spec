# AI Factory - Autonomous Development Workflow
#
# This GitHub Actions workflow triggers the AI Factory to autonomously
# generate enterprise applications from natural language requirements.
#
# Usage:
#   1. Go to Actions tab in GitHub
#   2. Select "AI Factory - Autonomous Development"
#   3. Click "Run workflow"
#   4. Enter your requirements in natural language
#   5. Wait 5-10 minutes for the AI to generate your app
#   6. Review the automatically created Pull Request

name: AI Factory - Autonomous Development

on:
  workflow_dispatch:
    inputs:
      requirement:
        description: 'Describe the application or feature to build (e.g., "Build a CRM with accounts and contacts")'
        required: true
        type: string
      include_tests:
        description: 'Generate tests automatically'
        required: false
        type: boolean
        default: true
      auto_deploy:
        description: 'Deploy to Vercel preview automatically'
        required: false
        type: boolean
        default: true

jobs:
  generate:
    name: Generate Application with AI
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # Setup Environment
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        run: npm install -g pnpm@latest
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      # Build Dependencies
      - name: Build ObjectStack Spec
        run: pnpm --filter @objectstack/spec build
      
      - name: Build AI Factory
        run: pnpm --filter @objectstack/ai-factory build
      
      # Run AI Factory
      - name: Generate Application with AI
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_ENVIRONMENT: ${{ secrets.PINECONE_ENVIRONMENT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "ğŸ¤– Starting AI Factory..."
          echo "Requirement: ${{ github.event.inputs.requirement }}"
          
          pnpm --filter @objectstack/ai-factory generate \
            --requirement="${{ github.event.inputs.requirement }}" \
            --include-tests=${{ github.event.inputs.include_tests }} \
            --auto-deploy=${{ github.event.inputs.auto_deploy }} \
            --output-dir="./generated" \
            --format=json > generation-result.json
          
          echo "âœ… Generation complete!"
      
      # Validate Generated Code
      - name: Validate Generated Code
        run: |
          echo "ğŸ” Validating generated code..."
          cd generated
          pnpm install
          pnpm typecheck
          echo "âœ… TypeScript validation passed!"
      
      # Run Tests
      - name: Run Generated Tests
        if: github.event.inputs.include_tests == 'true'
        run: |
          echo "ğŸ§ª Running tests..."
          cd generated
          pnpm test --coverage
          echo "âœ… All tests passed!"
      
      # Create Pull Request
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            feat: ğŸ¤– AI-generated application
            
            Generated by AI Factory from requirement:
            "${{ github.event.inputs.requirement }}"
          
          branch: ai-generated/${{ github.run_number }}
          delete-branch: true
          title: 'ğŸ¤– AI Generated: ${{ github.event.inputs.requirement }}'
          body: |
            ## ğŸ¤– AI-Generated Application
            
            **Requirement**: ${{ github.event.inputs.requirement }}
            **Generated by**: AI Factory (Orchestrator Agent)
            
            ### ğŸ“ What Changed
            - âœ… Data Models with Zod schemas
            - âœ… UI Components (views, forms, dashboards)
            - âœ… Business Logic (validation, workflows)
            - âœ… Tests (unit and integration)
            - âœ… Documentation
            
            ### Quality Checks
            - [x] Schema validation passed
            - [x] TypeScript compilation successful
            - [x] Tests passing
            - [x] Naming conventions followed
            
            ### ğŸš€ Deployment
            ${{ github.event.inputs.auto_deploy == 'true' && '**Preview deployed to Vercel**' || 'â­ï¸ Auto-deployment skipped' }}
            
            ---
            **ğŸ¤– This PR was created automatically by AI Factory**
          labels: |
            ai-generated
            enhancement
            automated
