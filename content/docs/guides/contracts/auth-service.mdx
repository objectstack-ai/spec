---
title: IAuthService Contract
description: Reference for the Auth Service contract — authentication, session verification, user resolution, and logout
---

# IAuthService Contract

The Auth Service handles **authentication** — verifying user identity through credentials, tokens, or external providers. It does not handle authorization (permissions); that is the responsibility of the Permission Service.

<Callout type="info">
**Source:** `packages/spec/src/system/contracts/auth-service.ts`  
**Token:** `AUTH_SERVICE`
</Callout>

---

## Interface Definition

```typescript
export interface IAuthService {
  // Core Authentication
  handleRequest(request: AuthRequest): Promise<AuthResult>;
  verify(token: string): Promise<AuthUser | null>;
  logout(token: string): Promise<void>;

  // User Resolution
  getCurrentUser(context: RequestContext): Promise<AuthUser | null>;
  getUserById(id: string): Promise<AuthUser | null>;

  // Session Management
  createSession(user: AuthUser, options?: SessionOptions): Promise<AuthSession>;
  refreshSession(refreshToken: string): Promise<AuthSession>;
  invalidateSession(sessionId: string): Promise<void>;
  listActiveSessions(userId: string): Promise<AuthSession[]>;

  // Provider Management
  getProviders(): Promise<AuthProvider[]>;
  getProvider(name: string): Promise<AuthProvider | null>;
}
```

---

## Core Authentication

### handleRequest

The primary entry point for authentication. Accepts credentials and returns an auth result with tokens.

```typescript
// Email/password authentication
const result = await authService.handleRequest({
  provider: 'credentials',
  credentials: {
    email: 'jane@example.com',
    password: 'secure-password-123',
  },
});

if (result.success) {
  console.log(result.user.id);         // "usr_01HQ3V5K8N2M4P6R7T9W"
  console.log(result.session.token);   // "eyJhbGciOiJIUzI1NiIs..."
  console.log(result.session.expiresAt); // "2025-01-21T10:30:00.000Z"
}
```

```typescript
// OAuth provider authentication
const result = await authService.handleRequest({
  provider: 'google',
  credentials: {
    code: 'oauth-authorization-code',
    redirectUri: 'https://app.example.com/auth/callback',
  },
});
```

### verify

Validates an access token and returns the associated user. Returns `null` for expired or invalid tokens.

```typescript
const user = await authService.verify(accessToken);
if (!user) {
  throw new Error('Invalid or expired token');
}
console.log(user.email); // "jane@example.com"
```

### logout

Invalidates the token and its associated session.

```typescript
await authService.logout(accessToken);
// Token is now invalid; subsequent verify() calls return null
```

---

## AuthUser Interface

The `AuthUser` object represents an authenticated user throughout the system.

```typescript
export interface AuthUser {
  id: string;
  email: string;
  name: string;
  avatar?: string;

  // Role and profile
  role: string;
  profile: string;
  permissions: string[];

  // Organization context
  orgId?: string;
  orgRole?: string;

  // Provider info
  provider: string;
  providerId?: string;

  // Metadata
  emailVerified: boolean;
  active: boolean;
  lastLoginAt?: string;
  metadata?: Record<string, unknown>;
}
```

| Property | Type | Description |
|:---|:---|:---|
| `id` | `string` | Unique user identifier (e.g., `usr_01HQ...`) |
| `email` | `string` | User's email address |
| `name` | `string` | Display name |
| `role` | `string` | System role (e.g., `admin`, `user`, `guest`) |
| `profile` | `string` | Security profile for permission resolution |
| `permissions` | `string[]` | Resolved permission set |
| `orgId` | `string?` | Current organization context |
| `provider` | `string` | Auth provider used (e.g., `credentials`, `google`) |

---

## User Resolution

### getCurrentUser

Resolves the authenticated user from a request context. Used by middleware to populate `context.user`.

```typescript
const user = await authService.getCurrentUser(requestContext);
if (user) {
  console.log(`Request from ${user.name} (${user.role})`);
}
```

### getUserById

Fetches a user by ID without requiring a token. Used internally for record ownership lookups.

```typescript
const owner = await authService.getUserById('usr_01HQ3V5K8N2M4P6R7T9W');
```

---

## Session Management

### createSession

Creates a new session for an authenticated user. Returns access and refresh tokens.

```typescript
const session = await authService.createSession(user, {
  expiresIn: '24h',
  device: 'web-browser',
  ipAddress: '192.168.1.100',
});

console.log(session.token);        // Access token
console.log(session.refreshToken); // Refresh token
console.log(session.expiresAt);    // Expiry timestamp
```

### refreshSession

Exchanges a refresh token for a new access token.

```typescript
const newSession = await authService.refreshSession(refreshToken);
// Old access token is invalidated
```

### invalidateSession / listActiveSessions

```typescript
// List all sessions for a user
const sessions = await authService.listActiveSessions(userId);

// Invalidate a specific session (e.g., remote logout)
await authService.invalidateSession(sessions[0].id);
```

---

## AuthSession Interface

```typescript
export interface AuthSession {
  id: string;
  userId: string;
  token: string;
  refreshToken: string;
  expiresAt: string;
  createdAt: string;
  device?: string;
  ipAddress?: string;
  lastActiveAt?: string;
}
```

---

## SessionOptions

```typescript
export interface SessionOptions {
  expiresIn?: string;    // Duration string: '1h', '24h', '7d'
  device?: string;       // Device identifier
  ipAddress?: string;    // Client IP address
  metadata?: Record<string, unknown>;
}
```

---

## AuthRequest / AuthResult

```typescript
export interface AuthRequest {
  provider: string;
  credentials: Record<string, unknown>;
  options?: {
    rememberMe?: boolean;
    mfaCode?: string;
  };
}

export interface AuthResult {
  success: boolean;
  user?: AuthUser;
  session?: AuthSession;
  error?: {
    code: string;
    message: string;
  };
  mfaRequired?: boolean;
  mfaChallenge?: {
    type: 'totp' | 'sms' | 'email';
    challengeId: string;
  };
}
```

---

## Provider Management

### getProviders

Lists all configured authentication providers.

```typescript
const providers = await authService.getProviders();
// [
//   { name: 'credentials', type: 'local', enabled: true },
//   { name: 'google', type: 'oauth', enabled: true },
//   { name: 'github', type: 'oauth', enabled: true },
// ]
```

<Callout type="tip">
**Multi-Factor Authentication:** When `AuthResult.mfaRequired` is `true`, the client must re-submit with `options.mfaCode` to complete authentication.
</Callout>

---

## Error Codes

| Code | Description |
|:---|:---|
| `INVALID_CREDENTIALS` | Email/password combination is incorrect |
| `USER_NOT_FOUND` | No user matches the provided identifier |
| `USER_DISABLED` | Account has been deactivated |
| `TOKEN_EXPIRED` | Access or refresh token has expired |
| `TOKEN_INVALID` | Token is malformed or has been revoked |
| `MFA_REQUIRED` | Multi-factor authentication is required |
| `MFA_INVALID` | MFA code is incorrect or expired |
| `PROVIDER_ERROR` | External auth provider returned an error |
| `SESSION_LIMIT` | Maximum concurrent sessions exceeded |
