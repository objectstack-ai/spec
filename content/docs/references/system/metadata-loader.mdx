---
title: Metadata Loader
description: Metadata loading and persistence protocol
---

# Metadata Loader

<Callout type="info">
**Source:** `packages/spec/src/system/metadata-loader.zod.ts`
</Callout>

## Overview

Metadata Loader protocol defines the standard interface for loading and saving metadata in ObjectStack. It enables consistent metadata operations across different storage backends (filesystem, HTTP, S3, databases) and serialization formats (JSON, YAML, TypeScript).

## TypeScript Usage

```typescript
import { 
  MetadataFormatSchema,
  MetadataStatsSchema,
  MetadataLoadOptionsSchema
} from '@objectstack/spec/system';

import type {
  MetadataFormat,
  MetadataStats,
  MetadataLoadOptions
} from '@objectstack/spec/system';

// Load metadata with options
const options: MetadataLoadOptions = {
  patterns: ['**/*.object.ts', '**/*.object.json'],
  validate: true,
  useCache: true,
  recursive: true
};
```

---

## Schemas

### MetadataFormat

Supported serialization formats for metadata.

**Values:**
- `json` - JSON format
- `yaml` - YAML format
- `typescript` - TypeScript files (.ts)
- `javascript` - JavaScript files (.js)

#### Example

```typescript
const format: MetadataFormat = 'json';
```

---

### MetadataStats

Information about a metadata item without loading its full content.

#### Properties

| Property | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| **size** | `number` | ✅ | File size in bytes |
| **modifiedAt** | `Date` | ✅ | Last modified date |
| **etag** | `string` | ✅ | Entity tag for cache validation |
| **format** | `MetadataFormat` | ✅ | Serialization format |
| **path** | `string` | optional | File system path |
| **metadata** | `Record<string, any>` | optional | Provider-specific metadata |

#### Example

```json
{
  "size": 2048,
  "modifiedAt": "2026-01-31T08:00:00Z",
  "etag": "abc123def456",
  "format": "json",
  "path": "/app/metadata/customer.object.json"
}
```

---

### MetadataLoadOptions

Options for loading metadata.

#### Properties

| Property | Type | Required | Default | Description |
| :--- | :--- | :--- | :--- | :--- |
| **patterns** | `string[]` | optional | - | File glob patterns to match |
| **ifNoneMatch** | `string` | optional | - | ETag for conditional request |
| **ifModifiedSince** | `Date` | optional | - | Only load if modified after this date |
| **validate** | `boolean` | optional | true | Validate against schema |
| **useCache** | `boolean` | optional | true | Enable caching |
| **filter** | `string` | optional | - | Filter predicate as string |
| **limit** | `number` | optional | - | Maximum items to load |
| **recursive** | `boolean` | optional | true | Search subdirectories |

#### Example

```typescript
const options: MetadataLoadOptions = {
  patterns: ['**/*.object.ts', '**/*.object.json'],
  ifModifiedSince: new Date('2026-01-01'),
  validate: true,
  useCache: true,
  recursive: true,
  limit: 100
};
```

---

## Usage Examples

### Load All Objects

```typescript
import { MetadataLoader } from '@objectstack/core';

const loader = new MetadataLoader();

const objects = await loader.load({
  patterns: ['**/*.object.ts'],
  validate: true,
  recursive: true
});

console.log(`Loaded ${objects.length} objects`);
```

### Load with Filtering

```typescript
const objects = await loader.load({
  patterns: ['**/*.object.ts'],
  filter: "(item) => item.name.startsWith('sys_')",
  limit: 50
});
```

### Conditional Loading (Cache Validation)

```typescript
const stats = await loader.getStats('/metadata/customer.object.json');

const objects = await loader.load({
  patterns: ['customer.object.json'],
  ifNoneMatch: stats.etag,
  ifModifiedSince: stats.modifiedAt
});

// Returns empty if not modified
if (objects.length === 0) {
  console.log('Using cached data');
}
```

### Load from Multiple Formats

```typescript
const metadata = await loader.load({
  patterns: [
    '**/*.object.ts',    // TypeScript
    '**/*.object.json',  // JSON
    '**/*.object.yaml'   // YAML
  ],
  validate: true
});
```

### Get Metadata Statistics

```typescript
const stats = await loader.getStats('/metadata/customer.object.json');

console.log(`Size: ${stats.size} bytes`);
console.log(`Modified: ${stats.modifiedAt}`);
console.log(`Format: ${stats.format}`);
console.log(`ETag: ${stats.etag}`);
```

---

## Glob Patterns

### Common Patterns

```typescript
// All object files
patterns: ['**/*.object.ts']

// All files in specific directory
patterns: ['src/domains/**/*.object.ts']

// Multiple file types
patterns: ['**/*.object.{ts,json,yaml}']

// Exclude patterns (using filter)
patterns: ['**/*.object.ts']
filter: "(item) => !item.name.startsWith('test_')"
```

### Pattern Examples

| Pattern | Matches |
| :--- | :--- |
| `**/*.object.ts` | All .object.ts files recursively |
| `src/**/*.object.ts` | All .object.ts in src/ directory |
| `*.object.json` | .object.json files in current directory only |
| `{a,b}/*.ts` | .ts files in a/ or b/ directories |

---

## Best Practices

### 1. Use Specific Patterns

```typescript
// ✅ Good - specific patterns
patterns: ['src/domains/**/*.object.ts']

// ❌ Avoid - too broad
patterns: ['**/*']
```

### 2. Enable Validation

```typescript
// ✅ Always validate in production
const options: MetadataLoadOptions = {
  validate: true,
  patterns: ['**/*.object.ts']
};
```

### 3. Use Caching

```typescript
// ✅ Enable caching for performance
const options: MetadataLoadOptions = {
  useCache: true,
  ifModifiedSince: lastLoadTime
};
```

### 4. Limit Results for Large Datasets

```typescript
// ✅ Use pagination for large datasets
const options: MetadataLoadOptions = {
  patterns: ['**/*.object.ts'],
  limit: 100
};
```

### 5. Handle Load Errors

```typescript
try {
  const metadata = await loader.load(options);
  // Process metadata
} catch (error) {
  if (error.code === 'VALIDATION_FAILED') {
    // Handle validation errors
    console.error('Invalid metadata:', error.details);
  } else {
    // Handle other errors
    throw error;
  }
}
```

---

## Storage Backends

### File System

```typescript
const loader = new FileSystemMetadataLoader({
  basePath: '/app/metadata'
});
```

### HTTP/Remote

```typescript
const loader = new HttpMetadataLoader({
  baseUrl: 'https://api.example.com/metadata'
});
```

### S3

```typescript
const loader = new S3MetadataLoader({
  bucket: 'my-metadata-bucket',
  prefix: 'metadata/'
});
```

### Database

```typescript
const loader = new DatabaseMetadataLoader({
  table: 'metadata',
  connectionString: 'postgresql://...'
});
```

---

## Related

- [Manifest](/docs/references/system/manifest) - Plugin manifest specification
- [Plugin](/docs/references/system/plugin) - Plugin protocol
- [Object](/docs/references/data/object) - Object metadata schema
