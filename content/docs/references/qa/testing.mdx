---
title: Testing
description: Testing protocol schemas
---

# Testing

<Callout type="info">
**Source:** `packages/spec/src/qa/testing.zod.ts`
</Callout>

## Overview

The Testing protocol provides a comprehensive framework for defining and executing tests in ObjectStack applications. It supports:
- Declarative test definitions
- Action-based testing (create, update, delete, API calls)
- Assertion operators for validation
- Test context and variable capture
- Setup and teardown lifecycle management

## TypeScript Usage

```typescript
import { 
  TestSuiteSchema,
  TestScenarioSchema,
  TestStepSchema,
  TestActionSchema,
  TestAssertionSchema,
  TestContextSchema
} from '@objectstack/spec/qa';

import type { 
  TestSuite,
  TestScenario,
  TestStep,
  TestAction,
  TestAssertion
} from '@objectstack/spec/qa';

// Define a test suite
const testSuite: TestSuite = {
  name: 'CRM Contact Tests',
  scenarios: [
    {
      id: 'test-001',
      name: 'Create and verify contact',
      tags: ['critical', 'crm'],
      steps: [
        {
          name: 'Create contact',
          action: {
            type: 'create_record',
            target: 'crm_contact',
            payload: {
              first_name: 'John',
              last_name: 'Doe',
              email: 'john.doe@example.com'
            }
          },
          assertions: [
            {
              field: 'body._id',
              operator: 'not_null',
              expectedValue: null
            }
          ],
          capture: {
            contactId: 'body._id'
          }
        }
      ]
    }
  ]
};

// Validate test suite
const validatedSuite = TestSuiteSchema.parse(testSuite);
```

---

## TestContext

Context variables and initial data for test execution.

**Type:** `Record<string, unknown>`

**Description:** Initial context or variables for the test

---

## TestActionType

Available test action types.

**Values:**
- `create_record` - Create a new record
- `update_record` - Update an existing record
- `delete_record` - Delete a record
- `read_record` - Read a single record
- `query_records` - Query multiple records
- `api_call` - Make an API call
- `run_script` - Execute a script
- `wait` - Wait for async processes

---

## TestAction

Defines an action to be performed during a test step.

**Properties:**
- `type` (TestActionType) - The type of action to perform
- `target` (string) - Target Object, API Endpoint, or Function Name
- `payload` (`Record<string, unknown>`, optional) - Data to send or use
- `user` (string, optional) - Run as specific user/role (impersonation)

**Example:**
```typescript
const action: TestAction = {
  type: 'create_record',
  target: 'project_task',
  payload: {
    subject: 'Implement feature',
    priority: 1
  },
  user: 'admin@example.com'
};
```

---

## TestAssertionType

Available assertion operators.

**Values:**
- `equals` - Value equals expected
- `not_equals` - Value does not equal expected
- `contains` - Value contains expected (string/array)
- `not_contains` - Value does not contain expected
- `is_null` - Value is null
- `not_null` - Value is not null
- `gt` - Value is greater than expected
- `gte` - Value is greater than or equal to expected
- `lt` - Value is less than expected
- `lte` - Value is less than or equal to expected
- `error` - Expecting an error

---

## TestAssertion

Defines an assertion to validate test results.

**Properties:**
- `field` (string) - Field path in the result to check (e.g., "body.data.0.status")
- `operator` (TestAssertionType) - Assertion operator to apply
- `expectedValue` (unknown) - The expected value

**Example:**
```typescript
const assertion: TestAssertion = {
  field: 'body.status',
  operator: 'equals',
  expectedValue: 'active'
};
```

---

## TestStep

A single step in a test scenario.

**Properties:**
- `name` (string) - Step name
- `description` (string, optional) - Step description
- `action` (TestAction) - Action to perform
- `assertions` (TestAssertion[], optional) - Assertions to validate
- `capture` (`Record<string, string>`, optional) - Capture result fields to context variables

**Example:**
```typescript
const step: TestStep = {
  name: 'Create and verify project',
  action: {
    type: 'create_record',
    target: 'project',
    payload: {
      name: 'Test Project',
      status: 'active'
    }
  },
  assertions: [
    {
      field: 'body._id',
      operator: 'not_null',
      expectedValue: null
    },
    {
      field: 'body.status',
      operator: 'equals',
      expectedValue: 'active'
    }
  ],
  capture: {
    projectId: 'body._id'
  }
};
```

---

## TestScenario

A complete test scenario with setup, steps, and teardown.

**Properties:**
- `id` (string) - Unique scenario identifier
- `name` (string) - Scenario name
- `description` (string, optional) - Scenario description
- `tags` (string[], optional) - Tags for categorization (e.g., "critical", "regression", "crm")
- `setup` (TestStep[], optional) - Steps to run before main test
- `steps` (TestStep[]) - Main test sequence
- `teardown` (TestStep[], optional) - Steps to cleanup
- `requires` (object, optional) - Environment requirements
  - `params` (string[], optional) - Required env vars or params
  - `plugins` (string[], optional) - Required plugins

**Example:**
```typescript
const scenario: TestScenario = {
  id: 'crm-contact-lifecycle',
  name: 'Complete contact lifecycle test',
  description: 'Create, update, query, and delete a contact',
  tags: ['integration', 'crm', 'critical'],
  setup: [
    {
      name: 'Initialize test data',
      action: {
        type: 'run_script',
        target: 'setupTestData',
        payload: {}
      }
    }
  ],
  steps: [
    {
      name: 'Create contact',
      action: {
        type: 'create_record',
        target: 'crm_contact',
        payload: {
          first_name: 'Jane',
          last_name: 'Smith',
          email: 'jane.smith@example.com'
        }
      },
      capture: {
        contactId: 'body._id'
      }
    },
    {
      name: 'Update contact',
      action: {
        type: 'update_record',
        target: 'crm_contact',
        payload: {
          _id: '{{contactId}}',
          phone: '+1-555-1234'
        }
      }
    }
  ],
  teardown: [
    {
      name: 'Cleanup test data',
      action: {
        type: 'delete_record',
        target: 'crm_contact',
        payload: {
          _id: '{{contactId}}'
        }
      }
    }
  ],
  requires: {
    plugins: ['@objectstack/driver-memory']
  }
};
```

---

## TestSuite

A collection of test scenarios.

**Properties:**
- `name` (string) - Test suite name
- `scenarios` (TestScenario[]) - Array of test scenarios

**Example:**
```typescript
const testSuite: TestSuite = {
  name: 'CRM Module Tests',
  scenarios: [
    {
      id: 'contact-crud',
      name: 'Contact CRUD operations',
      steps: [/* ... */]
    },
    {
      id: 'account-validation',
      name: 'Account validation rules',
      steps: [/* ... */]
    }
  ]
};
```

---

## Use Cases

### 1. API Integration Testing

```typescript
const apiTestSuite: TestSuite = {
  name: 'API Integration Tests',
  scenarios: [
    {
      id: 'api-auth',
      name: 'Test API authentication',
      steps: [
        {
          name: 'Login request',
          action: {
            type: 'api_call',
            target: '/api/auth/login',
            payload: {
              email: 'test@example.com',
              password: 'test123'
            }
          },
          assertions: [
            {
              field: 'body.token',
              operator: 'not_null',
              expectedValue: null
            }
          ],
          capture: {
            authToken: 'body.token'
          }
        }
      ]
    }
  ]
};
```

### 2. Permission Testing

```typescript
const permissionTest: TestScenario = {
  id: 'permission-check',
  name: 'Verify role-based access',
  steps: [
    {
      name: 'Admin can create',
      action: {
        type: 'create_record',
        target: 'project',
        payload: { name: 'Test' },
        user: 'admin@example.com'
      },
      assertions: [
        {
          field: 'body._id',
          operator: 'not_null',
          expectedValue: null
        }
      ]
    },
    {
      name: 'Guest cannot create',
      action: {
        type: 'create_record',
        target: 'project',
        payload: { name: 'Test' },
        user: 'guest@example.com'
      },
      assertions: [
        {
          field: 'error',
          operator: 'equals',
          expectedValue: 'Permission denied'
        }
      ]
    }
  ]
};
```

### 3. Workflow Testing

```typescript
const workflowTest: TestScenario = {
  id: 'approval-workflow',
  name: 'Test approval workflow',
  steps: [
    {
      name: 'Submit for approval',
      action: {
        type: 'update_record',
        target: 'expense_report',
        payload: {
          _id: '{{reportId}}',
          status: 'pending_approval'
        }
      }
    },
    {
      name: 'Wait for async processing',
      action: {
        type: 'wait',
        target: 'workflow_completion',
        payload: { timeout: 5000 }
      }
    },
    {
      name: 'Verify approval sent',
      action: {
        type: 'query_records',
        target: 'approval_request',
        payload: {
          filters: ['report_id', '=', '{{reportId}}']
        }
      },
      assertions: [
        {
          field: 'body.length',
          operator: 'gte',
          expectedValue: 1
        }
      ]
    }
  ]
};
```

---

## Best Practices

1. **Use descriptive names**: Make test names clear and self-documenting
2. **Tag appropriately**: Use tags like "critical", "regression", "smoke" for filtering
3. **Capture variables**: Use `capture` to pass data between steps
4. **Clean up**: Always use teardown to clean test data
5. **Test permissions**: Use the `user` field to test role-based access
6. **Test errors**: Use the `error` assertion operator to verify error handling
7. **Organize suites**: Group related scenarios into logical test suites
