---
title: 架构
description: 理解 ObjectStack 三位一体。ObjectQL、ObjectOS 和 ObjectUI 如何协作构建企业内核。
---

import { Layers, Database, Layout, ShieldCheck } from 'lucide-react';

ObjectStack 不是一个单体框架。它是围绕**分层架构**设计的可组合生态系统。我们称之为 **"ObjectStack 三位一体"。**

每一层都是解耦的，并通过标准 JSON 协议进行通信。这允许你替换实现（例如，将 React 渲染器替换为 Flutter 渲染器），而不会破坏堆栈的其余部分。

<Cards>
  <Card
    icon={<Database />}
    title="数据层（ObjectQL）"
    description="用于定义和访问的通用协议。"
  />
  <Card
    icon={<ShieldCheck />}
    title="控制层（ObjectOS）"
    description="用于编排和治理的业务内核。"
  />
  <Card
    icon={<Layout />}
    title="视图层（ObjectUI）"
    description="用于交互和渲染的投影引擎。"
  />
</Cards>

## 三位一体

### 1. 数据层：ObjectQL
**"通用协议"**

基础是 ObjectQL。它负责**数据定义**和**数据访问**。

* **角色：** 定义*结构*（Schema）和*意图*（查询 AST）。
* **职责：** 它知道*什么是* "客户" 对象，但它不知道*谁*正在访问它或*如何*显示它。
* **关键组件：** **编译器**。它接受抽象查询（`find customers where active = true`）并将其转换为特定底层数据库（Postgres、SQLite、MySQL）的优化 SQL。

### 2. 控制层：ObjectOS
**"业务内核"**

位于中间的是 ObjectOS。它负责**编排**和**治理**。

* **角色：** 管理请求的*生命周期*。
* **职责：**
    * **身份：** "这个用户是谁？"（身份验证）。
    * **安全：** "他们可以看到这个字段吗？"（RBAC/ACL）。
    * **同步：** "我们如何合并这些离线更改？"（冲突解决）。
    * **流程：** "保存此记录后会发生什么？"（工作流/触发器）。
* **关键概念：** 它充当网关。不允许直接访问数据库；所有内容都必须通过 OS 内核。

### 3. 视图层：ObjectUI
**"投影引擎"**

顶部是 ObjectUI。它负责**交互**和**渲染**。

* **角色：** 使用协议来渲染界面。
* **职责：** 它不包含硬编码的表单。相反，它询问 ObjectQL：*"客户的 schema 是什么？"* 并根据该元数据动态渲染布局。
* **关键概念：** **服务器驱动 UI（SDUI）**。后端规定布局、验证规则和可用操作。前端只是一个高度强大的渲染器。

---

## 请求生命周期

为了理解这些部分如何配合，让我们跟踪一个典型的用户交互——例如，销售代表在离线时更新交易状态。

1.  **交互（ObjectUI）：**
    *   用户将 "Deal" 拖到看板中的 "Closed Won" 列。
    *   UI 乐观地更新屏幕（0ms）。
    *   UI 向本地 ObjectOS 客户端分派 `update` 操作。

2.  **内核守卫（ObjectOS 客户端）：**
    *   客户端内核检查：*用户是否有权编辑 'Status'？*
    *   内核执行通用验证：*'Status' 是否是有效选项？*
    *   事务提交到 SQLite（本地 DB）。

3.  **同步（ObjectOS 同步）：**
    *   后台进程检测 SQLite 中的更改。
    *   将更改压缩为**操作载荷**。
    *   将载荷发送到服务器 API。

4.  **服务器执行（ObjectOS 服务器）：**
    *   服务器内核验证请求。
    *   服务器内核运行 "更新前" 触发器（例如，检查信用额度）。
    *   服务器将 AST 传递给 ObjectQL 编译器。

5.  **持久化（ObjectQL）：**
    *   编译器为 PostgreSQL 生成 `UPDATE deals SET status = 'closed_won' ...`。
    *   写入被提交。
    *   "更新后" 触发器触发（向经理发送电子邮件）。
